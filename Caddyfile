(static) {
	file_server * {
		root /tim/timApp/static
	}
}

(common) {
	encode gzip

	handle_path /static/* {
		import static
	}
	handle_path /csgenerated/* {
		file_server * {
			root /tim/timApp/modules/cs/generated
		}
	}
	handle_path /csstatic/* {
		file_server * {
			root /tim/timApp/modules/cs/static
		}
	}
	handle /cs/* {
		reverse_proxy * http://csplugin:5000
	}
	handle /svn/* {
		reverse_proxy * http://showfile:5000
	}
	handle_path /stackserver/* {
		reverse_proxy * http://stack-api-server
	}
	handle_errors {
		rewrite * /html/updating.html
		import static
	}
}

(tim_server) {
	import common
	@nobuffering {
		query caddy_nobuffering=1
	}
	handle @nobuffering {
		reverse_proxy * http://tim:5000 {
			flush_interval -1
		}
	}
	handle {
		reverse_proxy * http://tim:5000
	}
	log {
		output file /logs/access.log {
			roll_keep 100
			roll_keep_for 365d
		}
	}
}

{$CADDY_DOMAINS} {
	import tim_server
}

# For running tests (from IDE).
http://caddy:81 {
	import common
	handle {
		reverse_proxy * http://tim:5001
	}
}

# For running tests (from command line).
http://caddy:82 {
	import common
	handle {
		reverse_proxy * http://tests:5001
	}
}

{$CADDY_EXTRA_CONFIG}
